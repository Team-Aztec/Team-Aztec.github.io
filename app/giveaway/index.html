<!DOCTYPE html>
<html>
<head>
	<style id="style-background">
		html {
			overflow: hidden;
		}

		body {
			padding: 0;
			margin: 0;
			height: 100vh;
			width: 100vw;
			background: #222;
		}

		#container {
			margin: 16px auto;
			position: relative;
			height: 540px;
			width: 960px;
		}

		#canvas {
			position: absolute;
			top: 0;
			left: 0;
			height: 540px;
			width:960px;
			background: #FF000040;
		}

		#background {
			display: block;
			box-shadow: 0 0 0 4px #888;

			height: 540px;
			width: 960px;
		}

		button {
			display: block;
			font-size: 1.8em;
			padding: 8px 16px;
			margin: 16px auto;
			cursor: pointer;
		}

	</style>
</head>
<body>
	<div id="container">
		<svg id="background" version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg">
			<style>
				@font-face {
					font-family: 'localRoboto';
					src: url('/app/giveaway/Roboto-Bold.ttf') format('truetype');
				}
				svg {
					background: #000;
					--main: 255, 178, 46;
					--secondary: 255, 226, 158;
					--target: #8E652F;
					--line: #235535;
					--arrow: #000000;
				}

				text {
					font-family: 'localRoboto', 'roboto', 'Calibri';
					font-weight: bold;
					font-size: 192px;
					text-anchor: middle;
				}

				image {
					x: 0px;
					y: 90px;
					height: 450px;
					width: 960px;
				}
			</style>
			<defs>

				<filter id="noiseFilter">
					<feTurbulence
						type="fractalNoise"
						baseFrequency="0.75"
						numOctaves="1"
						stitchTiles="stitch"/>
				</filter>

				<linearGradient id="gradientColorDef">
					<stop style="stop-color:rgb(var(--main)); stop-opacity:1;" offset="0.6" />
					<stop style="stop-color:rgb(var(--secondary)); stop-opacity:1;" offset="0.9" />
				</linearGradient>
				<linearGradient
					id="innerGradient"
					xlink:href="#gradientColorDef"
					x1="66" y1="495" x2="147" y2="542"
					gradientUnits="userSpaceOnUse"
					spreadMethod="reflect" />
				<linearGradient
					id="outerGradient"
					xlink:href="#gradientColorDef"
					x1="500" y1="500" x2="500" y2="800"
					gradientUnits="userSpaceOnUse"
					spreadMethod="reflect" />
				<linearGradient
					id="textGradient"
					xlink:href="#gradientColorDef"
					x1="0" y1="0" x2="45" y2="35"
					gradientUnits="userSpaceOnUse"
					spreadMethod="reflect" />

				<g id="bracket-g">
					<path id="bracket" clip-path="url(#bracket-cut)"
					data-small-d="M 156,87 192,303 59,477 309,318 Z M 291,37 522,246 815,84 542,151 Z M 276,499 482,452 674,537 491,350 Z M 918,188 683,324 806,535 789,362 Z"
					d="M 159,31 185,267 50,521 308,281 Z M 259.55154,-5.42169 503.84873,230.01807 834,48 519,114 Z M 208,495 465,477 698,570 482,361 Z M 915,133 656,326 799,579 779,354 Z"
					></path>
					<clipPath id="bracket-cut">
						<use xlink:href="#bracket"></use>
					</clipPath>
				</g>
				<g id="target">
					<path d="M0,-30L0,-5 M-30,0L-5,0 M5,0L30,0 M0,5L0,30" stroke="var(--target)" stroke-width="2"/>
					<circle cx="0" cy="0" r="22" fill="none" stroke="var(--target)" stroke-width="2"/>
					<circle cx="0" cy="0" r="16" fill="none" stroke="var(--target)" stroke-width="2"/>
				</g>
			</defs>

			<g transform="translate(50, -170) scale(0.860)" opacity="0.2">
				<path fill="#000F"
					d="M290,53L290,143L310,138V278L220,300V340L60,660
						C 225,1075 775,1076 940,660
						L 780,340 V 300 L 690,278 V 138 L710,143 710,53 L 500,0 Z"></path>
				<path fill="none" style="stroke: url(#innerGradient)" stroke-width="6"
					d="M300,60V130L500,80L700,130V60L500,10Z
						M320,150V260L350,252.5V170L460,142.5V225L490,217.5V107.5Z
						M365,180V248.75L385,243.75V195L425,185V233.75L445,228.75V160Z
						M680,150V260L650,252.5V170L540,142.5V225L510,217.5V107.5Z
						M635,180V248.75L615,243.75V195L575,185V233.75L555,228.75V160Z
						M230,307V340L200,400H250L270,360L500,302.5L730,360L750,400H800L770,340V307.5L500,240Z M500,240V302.5
						M190,420L120,560H170L240,420Z
						M110,580L70,660L95,710L160,580Z
						M290,380L100,760L275,920L470,335Z
						M500,370L470,460H530Z
						M455,490L425,580L500,570L575,580L545,490Z
						M410,610L380,700L500,710L620,700L590,610L500,600Z
						M365,730L335,820L500,840L665,820L635,730L500,740Z
						M320,850L295,925L500,980L705,925L680,850L500,870Z
						M530,335L725,920L900,760L710,380Z
						M760,420L830,560H880L810,420Z
						M840,580L905,710L930,660L890,580Z"></path>
				<path style="fill: url(#outerGradient)"
					d=" M285,80.30 A485,485 0,1,0 715,80.30 V133.33 A438.2,438.2 0,1,1 285,133.33 Z"></path>
			</g>
			<path style="opacity:0.25"
				fill="#F80"
				filter="url(#noiseFilter)"
				d="M0,0V540H960V0Z"></path>

			<path fill="none" stroke="var(--line)"
				d="M70,0V540 M480,0V540 M890,0V540  M0,70H960 M0,270H960 M0,470H960  M70,70L890,470 M70,470L890,70"></path>
			<path fill="var(--target)"
				d="M0,0v70h70v-70Z M890,470v70h70v-70Z"></path>
			<path fill="none" stroke="var(--arrow)" stroke-width="2"
				d="M23,23L47,47 M23,43L23,23L43,23  M913,493l24,24 m-20,0h20v-20"></path>


			<use xlink:href="#target" x="150" y="220"></use>
			<use xlink:href="#target" x="900" y="180"></use>
			<use xlink:href="#target" x="100" y="500"></use>
			<use xlink:href="#target" x="550" y="450"></use>

			<use xlink:href="#bracket-g" style="
				fill: rgba(var(--secondary), 1);
				stroke: rgba(var(--main), 1);
				stroke-width: 80;
				opacity: 0.25;
			"></use>
			<text x="480" y="160" fill="url('#textGradient')" stroke="none"> GIVEAWAY </text>
			<image href="/app/giveaway/gun.png" xlink:href="/app/giveaway/gun.png"
				preserveaspectratio="xMidYMid meet"/>

			<use xlink:href="#bracket-g" style="
				fill: none;
				stroke: rgba(var(--main), 0.3);
				stroke-width: 4;
			"></use>
			<text x="480" y="160" fill="rgba(var(--main), 0.25)" stroke-width="2" stroke="rgb(var(--main))"> GIVEAWAY </text>
		</svg>
	</div>


	<button> Télécharger </button>
	<a style="display:none"></a>
	<script>
		const bg = document.getElementById('background')
		const button = document.querySelector('button')
		const a = document.querySelector('a')

		function toDataUrl(url, width, height) {
			const buffer = new Image()
			const canvas = document.createElement('canvas')
			
			return new Promise(resolve => {
				buffer.addEventListener('load', () => {
					console.log(buffer.width, buffer.height)
					width = width || buffer.width
					height = height || buffer.height

					canvas.setAttribute('width', width)
					canvas.setAttribute('height', height)

					canvas.getContext('2d')
						.drawImage(buffer, 0, 0, width, height)

					resolve(canvas.toDataURL('image/png'))
				})
				buffer.src = url
			})
		}

		toDataUrl('/app/giveaway/gun.png')
			.then(giftDataUrl => document
				.querySelector('image')
				.setAttribute('href', giftDataUrl))

		function parseImage(file) {
			const reader = new FileReader()
			reader.addEventListener('load', () => {
				document.querySelector('image')
					.setAttribute('href', reader.result)
			})
			reader.readAsDataURL(file)
		}

		document.body.addEventListener('dragover', e => e.preventDefault(), false)
		document.body.addEventListener('drop', (e) => {
			e.preventDefault()
			parseImage(e.dataTransfer.files[0])
		}, false)
		document.body.addEventListener('paste', (e) => {
			console.log(e, e.clipboardData.files[0])
			parseImage(e.clipboardData.files[0])
		})


		button.addEventListener('click', async (e) => {
			const svgData = new XMLSerializer().serializeToString(bg)
			const svgDataBase64 = btoa(unescape(encodeURIComponent(svgData)))
			const resultDataUrl = await toDataUrl(
				`data:image/svg+xml;charset=utf-8;base64,${svgDataBase64}`,
				960, 540)

			a.setAttribute('download', 'giveaway.png')
			a.setAttribute('href', resultDataUrl)
			setTimeout(() => a.click())
		})
	</script>
</body>
</html>
